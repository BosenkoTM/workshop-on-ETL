
# Бизнес-кейс «StockSense»

Самостоятельная работа

6.1.1. Развернуть ВМ [ubuntu_mgpu.ova](https://disk.yandex.ru/d/Psofa9xtbgUEOw) в [VirtualBox](https://disk.yandex.ru/d/3fD00plnL_a4Cw).

6.1.2. Клонировать на ПК задание **Бизнес-кейс «StockSense»** в домашний каталог ВМ. 

`git clone https://github.com/BosenkoTM/workshop-on-ETL.git`

6.1.3. Запустить контейнер с **Бизнес-кейсом «StockSense»**, изучить  основные элементы `DAG` в `Apache Airflow`. 
   - Создать `DAG` согласно алгоритму, который предоставит преподаватель.
   - Изучить логи, выполненного DAG. Скачать логи из контейнера в основную ОС.

Пример `docker-compose.yml` создает базу данных в Postgres:

- Host: `localhost`
- Port: `5433`
- Username: `airflow`
- Password: `airflow`
- Database: `airflow`

Эта база данных инициализируется таблицей `pageview_counts`.

**6.1.4.** Агрегированные данные бизнес-процесса, полученные в результате работы `DAG` в `Apache Airflow`, выгрузить в `Postgr SQL`. 

6.1.5. Спроектировать верхнеуровневую архитектуру аналитического решения **Бизнес-кейса «StockSense»** в `draw.io`. Необходимо использовать:
   - `Source Layer` - слой источников данных.
   - `Storage Layer` - слой хранения данных.
   - `Business Layer` - слой для доступа к данным пользователей.

6.1.6. Спроектировать архитектуру `DAG` **Бизнес-кейса «StockSense»** в `draw.io`. Необходимо использовать:
   - `Source Layer` - слой источников данных.
   - `Storage Layer` - слой хранения данных.
   - `Business Layer` - слой для доступа к данным пользователей.

6.1.7. Построить диаграмму Ганта работы `DAG` в `Apache Airflow`.

6.1.8. Результаты исследований представить в виде файла `ФИО-06.pdf`, в котором отражены следующие результаты:
- постановка задачи;
- исходный код всех DAGs, которые требовались для решения задачи, а также представить граф `DAG` в `Apache Airflow`;
- верхнеуровневая архитектура задания **Бизнес-кейса «StockSense»**, выполненная в `draw.io`;
- архитектура `DAG` **Бизнес-кейса «StockSense»** , выполненная в `draw.io`;
- диаграмма Ганта `DAG` в `Apache Airflow`;
- ERD-схема базы данных Postgre SQL;
- SQL-запросы, позволяющие проверить наличие выгруженных агрегированных данных бизнес-задачи. 

После проверки преподавателем работоспособности `DAG`, выгрузить отчет на портал [moodle]().


## Этапы запуска среды

1. **Остановка всех контейнеров Docker**  

   ```bash
   sudo docker stop $(sudo docker ps -a -q)
   ```

2. **Удаление всех контейнеров Docker**  
   ```bash
   sudo docker rm -f $(sudo docker ps -a -q)
   ```

3. **Удаление всех образов Docker**  
   ```bash
   sudo docker rmi -f $(sudo docker images -q)
   ```

4. **Создание нового Docker образа**  
   Эта команда строит новый Docker образ с именем `custom-airflow:slim-2.8.1-python3.11` на основе текущего контекста:
   ```bash
   sudo docker build -t custom-airflow:slim-2.8.1-python3.11 .
   ```

5. **Запуск среды с помощью Docker Compose**  

   ```bash
   sudo docker compose up --build
   ```

Веб-сервер инициализирует несколько задач, поэтому подождите несколько секунд, после чего сможете получить доступ к веб-серверу Airflow по адресу http://localhost:8080.

Чтобы остановить выполнение примеров, выполните следующую команду:

Для версии `v2`:

```bash
docker compose down -v
```

## Подключение к PostgreSQL через DBeaver для просмотра таблицы

1. **Убедитесь, что контейнер PostgreSQL работает**

   Перед подключением убедитесь, что ваш контейнер с PostgreSQL работает. Он настроен с использованием порта `5433`, что означает, что база данных будет доступна через этот порт на вашем локальном хосте.

2. **Запуск DBeaver**

   Если у вас еще нет DBeaver, скачайте и установите его с официального сайта: [DBeaver.io](https://dbeaver.io/).

3. **Создание нового подключения в DBeaver**

   После запуска DBeaver, выполните следующие шаги:

   - Откройте DBeaver.
   - Перейдите в меню **Database** > **New Database Connection**.
   - В поле поиска выберите **PostgreSQL** и нажмите **Next**.

4. **Настройка подключения**

   В появившемся окне заполните поля:

   - **Host**: `localhost` (или `127.0.0.1`).
   - **Port**: `5433` (порт, проброшенный в `docker-compose.yml`).
   - **Database**: `airflow` (это имя базы данных, как указано в `docker-compose.yml`).
   - **Username**: `airflow` (пользователь, указанный в `docker-compose.yml`).
   - **Password**: `airflow` (пароль, указанный в `docker-compose.yml`).

   Затем нажмите **Test Connection**, чтобы убедиться, что DBeaver может подключиться к базе данных.

5. **Подключение к базе данных**

   Если тест прошел успешно, нажмите **Finish** для завершения настройки подключения.

6. **Просмотр данных в таблице**

   - В левой панели DBeaver найдите подключение, которое вы только что создали (обычно оно будет отображаться с именем **airflow**).
   - Разверните подключение, перейдите в раздел **Schemas** > **public** > **Tables**.
   - Найдите таблицу **pageview_counts** (она была создана с помощью скрипта `create_table.sql`, загруженного в контейнер).
   - Щелкните правой кнопкой мыши на таблице **pageview_counts** и выберите **View Data** > **All Rows** для просмотра содержимого таблицы.

7. **Дополнительные действия**

   - Вы можете выполнять SQL-запросы через вкладку **SQL Editor**, например, для извлечения специфичных данных, агрегации или анализа.



## Индивидуальные задания

| Номер | Задание | Описание |
|-------|---------|----------|
| **1** | Получить данные за последний час для сайта **Yandex** | Скачайте данные за последний час для страницы Yandex и сохраните их в базе данных. После этого, напишите SQL-запрос для подсчета среднего числа просмотров по часам и визуализируйте данные на графике. |
| **2** | Получить данные за день для сайта **VK** | Скачайте данные за день для страницы VK и сохраните их в базе данных. Напишите SQL-запрос для подсчета максимального числа просмотров по часам, а затем визуализируйте данные для анализа. |
| **3** | Получить данные за месяц для сайта **Mail.ru** | Скачайте данные за месяц для страницы Mail.ru и сохраните их в базе данных. Используйте SQL-запрос для вычисления медианы просмотров по часам и постройте график для отображения результатов. |
| **4** | Получить данные за 2 месяца для сайта **Yandex** | Напишите SQL-запрос для подсчета среднего числа просмотров по часам для сайта Yandex. Визуализируйте результаты на графике для удобства анализа. |
| **5** | Получить данные за 3 месяца для сайта **Yandex**, **VK**, **Mail.ru** | Постройте график для отображения средних значений просмотров по часам для данных сайтов, используя информацию, сохраненную в базе данных. |
| **6** | Получить данные за последний день для сайта **Ozon** | Скачайте данные за последний день для страницы Ozon и сохраните их в базе данных. Напишите SQL-запрос для подсчета среднего числа просмотров по часам и визуализируйте результат. |
| **7** | Получить данные за месяц для сайта **Sberbank** | Скачайте данные за месяц для страницы Sberbank и сохраните их в базе данных. Напишите SQL-запрос для подсчета максимальных просмотров по часам и отобразите эти данные на графике. |
| **8** | Получить данные за день для сайта **Tinkoff** | Скачайте данные за день для страницы Tinkoff и сохраните их в базе данных. Напишите SQL-запрос для подсчета количества просмотров за день, а затем визуализируйте данные. |
| **9** | Получить данные за 2 месяца для сайта **Ozon** | Напишите SQL-запрос для получения максимального числа просмотров по часам для сайта Ozon. Постройте график, чтобы наглядно представить данные. |
| **10** | Получить данные за 2 месяца для сайта **Sberbank** | Постройте график для отображения числа просмотров по каждому часу для сайта **Sberbank** на основе сохраненных данных. |
| **11** | Получить данные за месяц для сайта **Rambler** | Скачайте данные за месяц для страницы Rambler, извлеките и сохраните их в базе данных. Напишите SQL-запрос для вычисления медианы просмотров по часам и постройте график с результатами. |
| **12** | Получить данные за день для сайта **Ru-net** | Скачайте данные за день для страницы Ru-net и сохраните их в базе данных. Напишите SQL-запрос для подсчета максимальных просмотров по часам и отобразите эти данные на графике. |
| **13** | Получить данные за неделю для сайта **Yandex** | Скачайте данные за неделю для страницы Yandex и сохраните их в базе данных. Напишите SQL-запрос для подсчета количества просмотров за каждый день недели и визуализируйте результаты. |
| **14** | Получить данные за 2 месяца для сайта **MGPU.ru** | Напишите SQL-запрос для подсчета среднего числа просмотров по часам для всех сайтов. Визуализируйте результаты для анализа. |
| **15** | Получить данные за 2 месяца для сайта **Apple** | Постройте график, который отображает топ-5 сайтов по числу просмотров за последний месяц на основе данных, полученных через Airflow. |
| **16** | Получить данные за месяц для сайта **Tinkoff** | Скачайте данные за месяц для страницы Tinkoff и сохраните их в базе данных. Напишите SQL-запрос для подсчета среднего числа просмотров по часам и визуализируйте эти данные. |
| **17** | Получить данные за день для сайта **VK** | Скачайте данные за день для страницы VK и сохраните их в базе данных. Напишите SQL-запрос для подсчета максимального числа просмотров по часам и визуализируйте результаты. |
| **18** | Получить данные за неделю для сайта **Sberbank** | Скачайте данные за неделю для страницы Sberbank и сохраните их в базе данных. Напишите SQL-запрос для подсчета количества просмотров за каждый день недели и визуализируйте результаты на графике. |
| **19** | Получить данные за неделю для сайта **Kommersant** | Напишите SQL-запрос, который будет выводить количество просмотров для всех страниц за последние 24 часа. Постройте график с результатами. |
| **20** | Получить данные за неделю для **Tinkoff** и **Ozon** | Постройте график, сравнивающий количество просмотров по дням для страниц **Tinkoff** и **Ozon**, используя SQL-запросы и визуализацию. |
| **21** | Получить данные за последний час для сайта **Wildberries** | Скачайте данные за последний час для страницы Wildberries и сохраните их в базе данных. Напишите SQL-запрос для подсчета среднего числа просмотров по часам и визуализируйте данные на графике. |
| **22** | Получить данные за неделю для сайта **Mail.ru** | Скачайте данные за неделю для страницы Mail.ru и сохраните их в базе данных. Напишите SQL-запрос для подсчета среднего числа просмотров по часам и визуализируйте результаты. |
| **23** | Получить данные за месяц для сайта **Yandex** | Скачайте данные за месяц для страницы Yandex и сохраните их в базе данных. Напишите SQL-запрос для подсчета максимальных просмотров по часам и отобразите результаты на графике. |
| **24** | Получить данные за 2 месяца для сайта **Gazeta.ru**  | Напишите SQL-запрос для вычисления медианы числа просмотров по часам для каждой страницы и визуализируйте результаты. |
| **25** | Получить данные за 2 месяца для сайта   **VK** и **Sberbank** | Постройте график, сравнивающий количество просмотров по дням для страниц **VK** и **Sberbank** с использованием SQL-запросов и визуализации. |
| **26** | Получить данные за день для сайта **Sberbank** | Скачайте данные за день для страницы Sberbank и сохраните их в базе данных. Напишите SQL-запрос для подсчета количества просмотров за день и визуализируйте эти данные. |
| **27** | Получить данные за последний час для сайта **Ozon** | Скачайте данные за последний час для страницы Ozon и сохраните их в базе данных. Напишите SQL-запрос для подсчета среднего числа просмотров по часам и визуализируйте данные на графике. |
| **28** | Получить данные за месяц для сайта **Ru-net** | Скачайте данные за месяц для страницы Ru-net и сохраните их в базе данных. Напишите SQL-запрос для подсчета максимальных просмотров по часам и визуализируйте результаты. |
| **29** | Получить данные за день для сайта  **Avito** | Напишите SQL-запрос, который будет выводить данные по всем сайтам за последний час. Постройте график с результатами. |
| **30** | Получить данные за день для сайта **Wildberries** | Постройте график, который отображает среднее количество просмотров по всем сайтам за последние 30 дней. |
