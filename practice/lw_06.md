# Лабораторная работа №6.1. Разработка полного ETL-процесса. Оркестровка конвейера данных. Бизнес-кейс «StockSense»

**Цель работы:**
1.  Научиться разворачивать комплексную среду для обработки данных (Airflow + PostgreSQL) с использованием Docker.
2.  Разработать и настроить полный ETL-процесс: получение данных из внешнего источника (Wikipedia pageviews), их обработка и загрузка в реляционную базу данных (PostgreSQL).
3.  Освоить инструменты оркестрации данных (Apache Airflow), написание SQL-запросов и визуализацию архитектуры решения.

**Репозиторий проекта:** `https://github.com/BosenkoTM/workshop-on-ETL/tree/main/business_case_stocksense_25`

---

## 1. Подготовка окружения

### 1.1. Развертывание ВМ
-  Разверните образ `ETL+devops_26.ova` в VirtualBox.
-  Запустите виртуальную машину.

### 1.2. Получение материалов
В терминале ВМ клонируйте репозиторий:
```bash
git clone https://github.com/BosenkoTM/workshop-on-ETL.git
```
*Рабочая директория:* `workshop-on-ETL/business_case_stocksense_25`

### 1.3. Запуск контейнеров
-  Перейдите в папку с проектом.
-  Соберите Docker-образ:
    ```bash
    sudo docker build -t custom-airflow:slim-2.8.1-python3.11 .
    ```
-  Запустите среду:
    ```bash
    sudo docker compose up --build
    ```
-  Дождитесь запуска веб-сервера (несколько секунд) и откройте в браузере: `http://localhost:8080`.

**Параметры подключения к БД (создается автоматически):**
*   **Host:** `localhost` (порт `5433` наружу)
*   **User/Pass:** `airflow`/`airflow`
*   **DB:** `airflow`
*   **Table:** `pageview_counts` (инициализируется при старте)

---

## 2. Ход работы

### 2.1. Работа с Airflow
-  Изучите предоставленный пример DAG в интерфейсе Airflow.
-  Создайте собственный DAG (или модифицируйте существующий) согласно вашему варианту задания.
-  Запустите DAG и дождитесь успешного выполнения.
-  Скачайте логи выполнения задач из интерфейса или напрямую из контейнера.

### 2.2. Работа с базой данных (DBeaver)
-  Установите/запустите DBeaver.
-  Создайте подключение к PostgreSQL:
    *   Host: `localhost`
    *   Port: `5433`
    *   Database: `airflow`
    *   Credentials: `airflow` / `airflow`
-  Проверьте наличие данных в таблице `pageview_counts`.
-  Выполните SQL-запросы для агрегации данных согласно вашему индивидуальному заданию.

### 2.3. Проектирование архитектуры (Draw.io)
Спроектируйте две схемы:
-  **Верхнеуровневая архитектура решения:**
    *   *Source Layer:* Wikipedia API / Dumps.
    *   *Storage Layer:* PostgreSQL (`pageview_counts`).
    *   *Business Layer:* SQL-аналитика, графики.
-  **Архитектура DAG:**
    *   Визуализируйте последовательность задач (Operators) в вашем конвейере (например: `get_data` -> `extract_gz` -> `fetch_pageviews` -> `write_to_postgres`).

---

## 3. Индивидуальные задания

Вам необходимо модифицировать параметры DAG (период, названия страниц) и выполнить SQL-анализ полученных данных.

| Вариант | Задание (Данные) | Аналитическая задача (SQL + Визуализация) |
|:---:|---|---|
| 1 | Последний час: **Yandex** | Среднее число просмотров по часам |
| 2 | День: **VK** | Максимальное число просмотров по часам |
| 3 | Месяц: **Mail.ru** | Медиана просмотров по часам |
| 4 | 2 месяца: **Yandex** | Среднее число просмотров по часам |
| 5 | 3 месяца: **Yandex, VK, Mail.ru** | Сравнение средних значений (график) |
| 6 | Последний день: **Ozon** | Среднее число просмотров по часам |
| 7 | Месяц: **Sberbank** | Максимальные просмотры по часам |
| 8 | День: **Tinkoff** | Общее количество просмотров за день |
| 9 | 2 месяца: **Ozon** | Максимальное число просмотров по часам |
| 10 | 2 месяца: **Sberbank** | Число просмотров по каждому часу |
| 11 | Месяц: **Rambler** | Медиана просмотров по часам |
| 12 | День: **Ru-net** | Максимальные просмотры по часам |
| 13 | Неделя: **Yandex** | Количество просмотров за каждый день недели |
| 14 | 2 месяца: **MGPU.ru** | Среднее число просмотров по часам |
| 15 | 2 месяца: **Apple** | Топ-5 страниц (если доступно несколько) или динамика |
| 16 | Месяц: **Tinkoff** | Среднее число просмотров по часам |
| 17 | День: **VK** | Максимальное число просмотров по часам |
| 18 | Неделя: **Sberbank** | Количество просмотров за каждый день недели |
| 19 | Неделя: **Kommersant** | Просмотры за последние 24 часа (почасовая) |
| 20 | Неделя: **Tinkoff** и **Ozon** | Сравнение просмотров по дням |
| 21 | Последний час: **Wildberries** | Среднее число просмотров по часам |
| 22 | Неделя: **Mail.ru** | Среднее число просмотров по часам |
| 23 | Месяц: **Yandex** | Максимальные просмотры по часам |
| 24 | 2 месяца: **Gazeta.ru** | Медиана числа просмотров по часам |
| 25 | 2 месяца: **VK** и **Sberbank** | Сравнение просмотров по дням |
| 26 | День: **Sberbank** | Общее количество просмотров за день |
| 27 | Последний час: **Ozon** | Среднее число просмотров по часам |
| 28 | Месяц: **Ru-net** | Максимальные просмотры по часам |
| 29 | День: **Avito** | Данные по всем скачанным сайтам за последний час |
| 30 | День: **Wildberries** | Среднее кол-во просмотров (динамика за 30 дней, если данные позволяют, или за доступный период) |

---

## 4. Требования к отчетности

Все результаты работы загружаются в **публичный Git-репозиторий**. На портал LMS Moodle предоставляется **только ссылка**.

**Состав репозитория:**
1.  **Файл отчета `ФИО-06.pdf`:**
    *   Постановка задачи.
    *   Верхнеуровневая архитектура (скриншот из draw.io).
    *   Архитектура DAG (скриншот из draw.io).
    *   Диаграмма Ганта выполнения DAG (скриншот из Airflow).
    *   ERD-схема базы данных (скриншот из DBeaver или draw.io).
    *   Результаты выполнения SQL-запросов (скриншоты таблиц/графиков).
2.  **Исходный код DAG** (`.py` файл).
3.  **SQL-скрипт** с запросами для аналитики.

---

## 5. Критерии оценки (Максимум 10 баллов)

| Критерий | Баллы | Описание |
|---|---|---|
| **Развертывание среды** | 1 | Успешный запуск контейнеров, доступность Airflow UI и PostgreSQL. |
| **Реализация ETL (DAG)** | 3 | DAG написан корректно, выполняет загрузку данных в БД согласно варианту. Ошибки выполнения отсутствуют. |
| **Работа с БД (SQL)** | 2 | Данные корректно записаны в PostgreSQL. Написан рабочий SQL-запрос для аналитической задачи варианта. |
| **Архитектура и документация** | 2 | В отчете представлены корректные схемы (общая архитектура + архитектура DAG + ERD). |
| **Визуализация и отчет** | 2 | Представлена диаграмма Ганта. Построены графики/таблицы на основе данных. Репозиторий оформлен аккуратно. |

---

## 6. Полезные команды (Управление Docker)

*   **Остановить все:** `sudo docker compose down -v`
*   **Остановить принудительно (все контейнеры):** `sudo docker stop $(sudo docker ps -a -q)`
*   **Удалить все контейнеры:** `sudo docker rm -f $(sudo docker ps -a -q)`
*   **Очистить образы:** `sudo docker rmi -f $(sudo docker images -q)`
```